<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ì´ë“œ&ì¸ì†”ì ê´€ë¦¬</title>
    <style>
        .selected-row {
            background-color: #e0e0e0;
        }
        tr:hover {
            cursor: pointer;
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <h1>ê°€ì´ë“œ&ì¸ì†”ì ê´€ë¦¬</h1>
    <nav>
        <a href="index.html">í™ˆìœ¼ë¡œ</a>
    </nav>
    
    <section>
        <h2>ê°€ì´ë“œ/ì¸ì†”ì ì¶”ê°€</h2>
        <form id="guideForm">
            <div>
                <label for="guideName">ì´ë¦„:</label>
                <input type="text" id="guideName" required>
            </div>
            <div>
                <label for="guideType">ìœ í˜•:</label>
                <select id="guideType">
                    <option value="ì¸ì†”ì">ì¸ì†”ì</option>
                    <option value="ê°€ì´ë“œ">ê°€ì´ë“œ</option>
                </select>
            </div>
            <div>
                <label for="affiliation">ì†Œì†:</label>
                <select id="affiliation" required>
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            <button type="submit">ì¶”ê°€</button>
        </form>
    </section>

    <section>
        <h2>ì¶”ê°€ëœ ê°€ì´ë“œ&ì¸ì†”ì ëª©ë¡</h2>
        <table border="1">
            <thead>
                <tr>
                    <th>ë²ˆí˜¸</th>
                    <th>ì´ë¦„</th>
                    <th>ìœ í˜•</th>
                    <th>ì†Œì†</th>
                    <th>í–‰ì‚¬</th>
                    <th>NPSí‰ê· </th>
                    <th>ìµœê·¼ ë°°ì •ì¼</th>
                    <th>ì‘ì—…</th>
                </tr>
            </thead>
            <tbody id="guideList"></tbody>
        </table>
        
        <div style="margin-top: 20px;">
            <button onclick="showAssignedEvents()">ë‹´ë‹¹í–‰ì‚¬</button>
            <button onclick="showEvaluations()">í‰ê°€ ê´€ë¦¬</button>
        </div>
        
        <div id="additionalInfo" style="margin-top: 20px;"></div>
    </section>

    <script src="shared.js"></script>
    <script>
        let selectedGuideId = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            addCurrentDateDisplay();
            loadLandOperatorsToSelect();
            loadGuides();
            
            document.getElementById('guideForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const guide = {
                    id: Date.now(),
                    name: document.getElementById('guideName').value,
                    type: document.getElementById('guideType').value,
                    affiliation: document.getElementById('affiliation').value,
                    npsAverage: null,
                    lastAssignedDate: null
                };
                
                addGuide(guide);
                this.reset();
                loadGuides();
            });
        });

        function loadLandOperatorsToSelect() {
            const landOperators = getLandOperators();
            const select = document.getElementById('affiliation');
            
            select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            landOperators.forEach(operator => {
                const option = document.createElement('option');
                option.value = operator.companyName;
                option.textContent = operator.companyName;
                select.appendChild(option);
            });
        }

        function loadGuides() {
            const guides = getGuides();
            const tbody = document.getElementById('guideList');
            tbody.innerHTML = '';
            
            guides.forEach((guide, index) => {
                const events = getEvents();
                console.log('ê°€ì´ë“œ:', guide.name, 'ID:', guide.id, 'Type:', typeof guide.id);
                console.log('ëª¨ë“  í–‰ì‚¬:', events.map(e => ({name: e.name, guideId: e.guideId, guideIdType: typeof e.guideId})));
                
                const assignedEvents = events.filter(event => String(event.guideId) === String(guide.id));
                console.log('ë§¤ì¹­ëœ í–‰ì‚¬:', assignedEvents.map(e => e.name));
                const eventCount = assignedEvents.length;
                
                // Calculate last assigned date (most recent completed event end date)
                let lastAssignedDate = '-';
                if (assignedEvents.length > 0) {
                    let latestEndDate = null;
                    const currentDate = getCurrentDate();
                    
                    assignedEvents.forEach(event => {
                        if (event.period && event.period.includes('-')) {
                            const parts = event.period.split(' - ');
                            let endDateStr = parts.length === 2 ? parts[1].trim() : event.period.split('-')[1]?.trim();
                            const endDate = parseEventDate(endDateStr);
                            
                            // Only include events that have ended (current date > event end date)
                            if (endDate && currentDate > endDate) {
                                if (!latestEndDate || endDate > latestEndDate) {
                                    latestEndDate = endDate;
                                }
                            }
                        }
                    });
                    
                    if (latestEndDate) {
                        lastAssignedDate = latestEndDate.toLocaleDateString('ko-KR').replace(/\. /g, '.').replace(/\.$/, '');
                    }
                }
                
                const row = tbody.insertRow();
                row.dataset.guideId = guide.id;
                row.onclick = function() { selectGuide(guide.id); };
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${guide.name}</td>
                    <td>${guide.type}</td>
                    <td>${guide.affiliation}</td>
                    <td>${eventCount || '-'}</td>
                    <td>${guide.npsAverage || '-'}</td>
                    <td>${lastAssignedDate}</td>
                    <td>
                        <button onclick="event.stopPropagation(); deleteGuide(${guide.id})">ì‚­ì œ</button>
                    </td>
                `;
            });
        }
        
        function selectGuide(guideId) {
            selectedGuideId = guideId;
            const rows = document.querySelectorAll('#guideList tr');
            rows.forEach(row => row.classList.remove('selected-row'));
            const selectedRow = document.querySelector(`[data-guide-id="${guideId}"]`);
            if (selectedRow) {
                selectedRow.classList.add('selected-row');
            }
        }

        function deleteGuide(id) {
            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                removeGuide(id);
                loadGuides();
            }
        }

        function showAssignedEvents() {
            if (!selectedGuideId) {
                alert('ê°€ì´ë“œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const events = getEvents();
            const guides = getGuides();
            const selectedGuide = guides.find(g => g.id === selectedGuideId);
            const infoDiv = document.getElementById('additionalInfo');
            
            if (!selectedGuide) {
                infoDiv.innerHTML = '<p>ì„ íƒëœ ê°€ì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            const assignedEvents = events.filter(event => event.guideId == selectedGuideId);
            
            let html = `<h3>${selectedGuide.name}ì˜ ë‹´ë‹¹í–‰ì‚¬</h3>`;
            
            if (assignedEvents.length === 0) {
                html += '<p>ë°°ì •ëœ í–‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                html += `
                    <table border="1">
                        <thead>
                            <tr>
                                <th>í–‰ì‚¬ëª…</th>
                                <th>í–‰ì‚¬ ê¸°ê°„</th>
                                <th>ì¼ì •</th>
                                <th>ìƒíƒœ</th>
                                <th>í›„ê¸° ë§ˆê°ì¼</th>
                                <th>ì§‘ê³„ ìƒíƒœ</th>
                                <th>ì°¸ì—¬ì¸ì›</th>
                                <th>ìƒì„¸ë³´ê¸°</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                assignedEvents.forEach(event => {
                    const participantCount = event.participants ? event.participants.length : 0;
                    const schedule = calculateSchedule(event.period);
                    
                    // Determine event status based on current date
                    let eventStatus = 'ì˜ˆì •';
                    let aggregationStatus = 'ëŒ€ê¸°';
                    
                    if (event.period && event.period.includes('-')) {
                        const parts = event.period.split(' - ');
                        let startDateStr = parts.length === 2 ? parts[0].trim() : event.period.split('-')[0]?.trim();
                        let endDateStr = parts.length === 2 ? parts[1].trim() : event.period.split('-')[1]?.trim();
                        
                        const startDate = parseEventDate(startDateStr);
                        const endDate = parseEventDate(endDateStr);
                        
                        if (startDate && endDate) {
                            const eventStartDate = new Date(startDate);
                            eventStartDate.setHours(0, 0, 0, 0);
                            const eventEndDate = new Date(endDate);
                            eventEndDate.setHours(0, 0, 0, 0);
                            const compareDate = new Date(getCurrentDate());
                            compareDate.setHours(0, 0, 0, 0);
                            
                            if (compareDate < eventStartDate) {
                                eventStatus = 'ì˜ˆì •';
                            } else if (compareDate >= eventStartDate && compareDate < eventEndDate) {
                                eventStatus = 'ì§„í–‰ì¤‘';
                            } else if (compareDate >= eventEndDate) {
                                eventStatus = 'ì¢…ë£Œ';
                            }
                        }
                    }
                    
                    // Calculate review deadline (end date + 14 days) and aggregation status
                    let reviewDeadline = '-';
                    if (event.period && event.period.includes('-')) {
                        const parts = event.period.split(' - ');
                        let endDateStr = parts.length === 2 ? parts[1].trim() : event.period.split('-')[1]?.trim();
                        const endDate = parseEventDate(endDateStr);
                        if (endDate) {
                            const deadlineDate = new Date(endDate);
                            deadlineDate.setDate(deadlineDate.getDate() + 14);
                            deadlineDate.setHours(0, 0, 0, 0);
                            reviewDeadline = deadlineDate.toLocaleDateString('ko-KR').replace(/\. /g, '.').replace(/\.$/, '');
                            
                            // Determine aggregation status based on review deadline
                            const currentDate = getCurrentDate();
                            if (currentDate >= deadlineDate) {
                                aggregationStatus = 'ì™„ë£Œ';
                            }
                        }
                    }
                    
                    html += `
                        <tr>
                            <td>${event.name}</td>
                            <td>${event.period}</td>
                            <td>${schedule}</td>
                            <td>${eventStatus}</td>
                            <td>${reviewDeadline}</td>
                            <td>${aggregationStatus}</td>
                            <td>${participantCount}ëª…</td>
                            <td><button onclick="viewEventDetail(${event.id})">ìƒì„¸ë³´ê¸°</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            infoDiv.innerHTML = html;
        }
        
        function viewEventDetail(eventId) {
            const events = getEvents();
            const event = events.find(e => e.id === eventId);
            const infoDiv = document.getElementById('additionalInfo');
            
            if (!event) {
                infoDiv.innerHTML = '<p>í–‰ì‚¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            let html = `<h3>${event.name} - ì°¸ê°€ì ìƒì„¸ ì •ë³´</h3>`;
            
            if (!event.participants || event.participants.length === 0) {
                html += '<p>ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                html += `
                    <table border="1">
                        <thead>
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>ìœ í˜•</th>
                                <th>1ì°¨ ì•Œë¦¼í†¡ ë°œì†¡ ì—¬ë¶€</th>
                                <th>2ì°¨ ì•Œë¦¼í†¡ ë°œì†¡ ì—¬ë¶€</th>
                                <th>í›„ê¸° ì‘ì„± ì—¬ë¶€</th>
                                <th>ì œì¶œ í˜„í™©</th>
                                <th>ìƒíƒœ</th>
                                <th>ì œì¶œì¼</th>
                                <th>ì—…ë°ì´íŠ¸</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                event.participants.forEach(participant => {
                    const typeEmoji = participant.type === 'ëŒ€í‘œì˜ˆì•½ì' ? 'ğŸ‘‘' : 'ğŸ‘¥';
                    const firstNotification = participant.firstNotificationSent ? 
                        `<span style="color: green;">Y</span><br><small>${formatDate(participant.firstNotificationDate)}</small>` : 
                        '<span style="color: red;">N</span>';
                    const secondNotification = participant.secondNotificationSent ? 
                        `<span style="color: green;">Y</span><br><small>${formatDate(participant.secondNotificationDate)}</small>` : 
                        '<span style="color: red;">N</span>';
                    const reviewWritten = participant.reviewSubmitted ? 
                        '<span style="color: green;">ì‘ì„±ì™„ë£Œ</span>' : 
                        '<span style="color: red;">ë¯¸ì‘ì„±</span>';
                    // Calculate submit status - for representatives, show group completion rate
                    let submitStatus;
                    if (participant.type === 'ëŒ€í‘œì˜ˆì•½ì') {
                        // Find all participants in this representative's group (including the representative)
                        const groupMembers = event.participants.filter(p => 
                            p.id === participant.id || String(p.representative) === String(participant.id)
                        );
                        const totalMembers = groupMembers.length;
                        const submittedMembers = groupMembers.filter(p => p.reviewSubmitted).length;
                        const completionRate = totalMembers > 0 ? ((submittedMembers / totalMembers) * 100).toFixed(1) : 0;
                        
                        if (submittedMembers === totalMembers) {
                            submitStatus = `<span style="color: green;">${submittedMembers}/${totalMembers} (${completionRate}%)</span>`;
                        } else if (submittedMembers > 0) {
                            submitStatus = `<span style="color: orange;">${submittedMembers}/${totalMembers} (${completionRate}%)</span>`;
                        } else {
                            submitStatus = `<span style="color: red;">${submittedMembers}/${totalMembers} (${completionRate}%)</span>`;
                        }
                    } else {
                        // For companions, show individual status
                        submitStatus = participant.reviewSubmitted ? 
                            '<span style="color: green;">ì œì¶œì™„ë£Œ</span>' : 
                            '<span style="color: orange;">ë¯¸ì œì¶œ</span>';
                    }
                    const status = getParticipantStatus(participant, event.period);
                    const submitDate = participant.reviewSubmitted && participant.reviewSubmitDate ? 
                        formatDate(participant.reviewSubmitDate) : '-';
                    
                    // Get last update date
                    let updateDate = '-';
                    if (participant.deletedDate) {
                        updateDate = formatDate(participant.deletedDate);
                    } else if (participant.lastModifiedDate) {
                        updateDate = formatDate(participant.lastModifiedDate);
                    } else if (participant.reviewSubmitDate) {
                        updateDate = formatDate(participant.reviewSubmitDate);
                    }
                    
                    // Style status based on type
                    let statusStyle = '';
                    switch(status) {
                        case 'ì œì¶œ':
                            statusStyle = 'color: #28a745; font-weight: bold;';
                            break;
                        case 'ìˆ˜ì •ë¨':
                            statusStyle = 'color: #ffc107; font-weight: bold;';
                            break;
                        case 'ì‚­ì œë¨':
                            statusStyle = 'color: #dc3545; font-weight: bold;';
                            break;
                        case 'í‰ê°€ ì™„ë£Œ':
                            statusStyle = 'color: #6c757d; font-weight: bold;';
                            break;
                        case 'ë¯¸ì œì¶œ':
                            statusStyle = 'color: #999;';
                            break;
                    }
                    
                    html += `
                        <tr>
                            <td>${participant.name}</td>
                            <td>${typeEmoji} ${participant.type}</td>
                            <td>${firstNotification}</td>
                            <td>${secondNotification}</td>
                            <td>${reviewWritten}</td>
                            <td>${submitStatus}</td>
                            <td style="${statusStyle}">${status}</td>
                            <td>${submitDate}</td>
                            <td>${updateDate}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            infoDiv.innerHTML = html;
        }
        
        function getParticipantStatus(participant, eventPeriod) {
            // Use the same logic as review management
            if (participant.reviewStatus === 'ì‚­ì œë¨') return 'ì‚­ì œë¨';
            
            if (!participant.reviewSubmitted) {
                return 'ë¯¸ì œì¶œ';
            }
            
            // Check if review deadline has passed (event end + 14 days)
            if (eventPeriod && eventPeriod.includes('-')) {
                const parts = eventPeriod.split(' - ');
                let endDateStr = parts.length === 2 ? parts[1].trim() : eventPeriod.split('-')[1]?.trim();
                const endDate = parseEventDate(endDateStr);
                if (endDate) {
                    const reviewDeadlineDate = new Date(endDate);
                    reviewDeadlineDate.setDate(reviewDeadlineDate.getDate() + 14);
                    reviewDeadlineDate.setHours(0, 0, 0, 0);
                    
                    const currentDate = getCurrentDate();
                    
                    if (currentDate >= reviewDeadlineDate) {
                        return 'í‰ê°€ ì™„ë£Œ';
                    }
                }
            }
            
            if (participant.reviewStatus === 'ìˆ˜ì •ë¨') {
                return 'ìˆ˜ì •ë¨';
            }
            
            return 'ì œì¶œ';
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function updateParticipantReview(eventId, participantId) {
            const events = getEvents();
            const event = events.find(e => e.id === eventId);
            const participant = event.participants.find(p => p.id === participantId);
            
            if (participant) {
                if (confirm(`${participant.name}ë‹˜ì˜ í›„ê¸°ë¥¼ ì œì¶œì™„ë£Œë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    participant.reviewSubmitted = true;
                    participant.reviewSubmitDate = new Date().toISOString();
                    
                    localStorage.setItem(STORAGE_KEYS.EVENTS, JSON.stringify(events));
                    viewEventDetail(eventId);
                    
                    alert('ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        function showEvaluations() {
            if (!selectedGuideId) {
                alert('ê°€ì´ë“œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const guides = getGuides();
            const selectedGuide = guides.find(g => g.id === selectedGuideId);
            const infoDiv = document.getElementById('additionalInfo');
            
            if (!selectedGuide) {
                infoDiv.innerHTML = '<p>ì„ íƒëœ ê°€ì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            const events = getEvents();
            const assignedEvents = events.filter(event => String(event.guideId) === String(selectedGuideId));
            
            const currentDate = getCurrentDate();
            
            // Filter events that have started (where current date is on or after start date)
            const activeEvents = assignedEvents.filter(event => {
                if (!event.period || !event.period.includes('-')) return false;
                
                // Handle cases like "2025-09-01 - 2025-09-10" or "2025.09.01 - 2025.09.10"
                const parts = event.period.split(' - ');
                let startDateStr;
                
                if (parts.length === 2) {
                    // Format: "start - end"
                    startDateStr = parts[0].trim();
                } else {
                    // Fallback: split by first '-' and take everything before
                    const dashIndex = event.period.indexOf('-');
                    if (dashIndex === -1) return false;
                    startDateStr = event.period.substring(0, dashIndex).trim();
                }
                
                const startDate = parseEventDate(startDateStr);
                if (!startDate) return false;
                
                // Reset time for accurate comparison
                const eventStartDate = new Date(startDate);
                eventStartDate.setHours(0, 0, 0, 0);
                const compareDate = new Date(currentDate);
                compareDate.setHours(0, 0, 0, 0);
                
                return compareDate >= eventStartDate;
            });
            
            let html = `<h3>${selectedGuide.name}ì˜ í‰ê°€ ê´€ë¦¬</h3>`;
            
            if (activeEvents.length === 0) {
                html += '<p>ì§„í–‰ ì¤‘ì¸ í–‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                html += `
                    <table border="1">
                        <thead>
                            <tr>
                                <th>í–‰ì‚¬ëª…</th>
                                <th>í–‰ì‚¬ ê¸°ê°„</th>
                                <th>ì¼ì •</th>
                                <th>ìƒíƒœ</th>
                                <th>ì œì¶œì</th>
                                <th>NPS í‰ê· </th>
                                <th>ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                activeEvents.forEach(event => {
                    const schedule = calculateSchedule(event.period);
                    const reviews = getReviews().filter(r => r.eventId === event.id);
                    const totalParticipants = event.participants ? event.participants.length : 0;
                    const submittedReviews = reviews.filter(r => r.status !== 'ì‚­ì œë¨').length;
                    const npsSum = reviews.reduce((sum, r) => sum + (r.npsScore || 0), 0);
                    const npsAverage = submittedReviews > 0 ? (npsSum / submittedReviews).toFixed(1) : '-';
                    
                    // Determine status based on current date and event period
                    let status = 'ì§„í–‰ì¤‘';
                    if (event.period && event.period.includes('-')) {
                        const parts = event.period.split(' - ');
                        let endDateStr = parts.length === 2 ? parts[1].trim() : event.period.split('-')[1]?.trim();
                        const endDate = parseEventDate(endDateStr);
                        if (endDate) {
                            const eventEndDate = new Date(endDate);
                            eventEndDate.setHours(23, 59, 59, 999);
                            const compareDate = new Date(currentDate);
                            compareDate.setHours(0, 0, 0, 0);
                            
                            // Calculate review deadline (end date + 14 days)
                            const reviewDeadlineDate = new Date(endDate);
                            reviewDeadlineDate.setDate(reviewDeadlineDate.getDate() + 14);
                            reviewDeadlineDate.setHours(0, 0, 0, 0);
                            
                            if (compareDate > eventEndDate) {
                                if (compareDate >= reviewDeadlineDate) {
                                    status = 'ì¢…ë£Œ';
                                } else {
                                    status = 'í›„ê¸° ìˆ˜ì§‘ì¤‘';
                                }
                            }
                        }
                    }
                    
                    html += `
                        <tr>
                            <td>${event.name}</td>
                            <td>${event.period}</td>
                            <td>${schedule}</td>
                            <td>${status}</td>
                            <td>${submittedReviews}/${totalParticipants}</td>
                            <td>${npsAverage}</td>
                            <td><button onclick="viewEvaluationDetail(${event.id})">ìƒì„¸ë³´ê¸°</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            infoDiv.innerHTML = html;
        }
        
        function parseEventDate(dateStr) {
            // Handle both formats: 2025.09.10 and 2025-09-10
            let parts;
            if (dateStr.includes('.')) {
                parts = dateStr.split('.');
            } else if (dateStr.includes('-')) {
                parts = dateStr.split('-');
            } else {
                return null;
            }
            
            if (parts.length !== 3) return null;
            
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const day = parseInt(parts[2]);
            
            return new Date(year, month, day);
        }
        
        function getCurrentDate() {
            const simulatedDate = localStorage.getItem('simulatedDate');
            if (simulatedDate) {
                return new Date(simulatedDate);
            }
            return new Date();
        }
        
        function calculateSchedule(period) {
            if (!period || !period.includes('-')) return '-';
            
            // Handle both formats: "start - end" and "start-end"
            const parts = period.includes(' - ') ? period.split(' - ') : period.split('-');
            if (parts.length !== 2) return period;
            
            const startDate = parseEventDate(parts[0].trim());
            const endDate = parseEventDate(parts[1].trim());
            
            if (!startDate || !endDate) return period;
            
            const diffTime = Math.abs(endDate - startDate);
            const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // ë‚ ì§œ ì°¨ì´ 
            const nights = totalDays - 1; // ìˆ™ë°• ìˆ˜ (ë§ˆì§€ë§‰ ë‚  ì œì™¸)
            const days = totalDays; // ì—¬í–‰ ì¼ìˆ˜
            
            return `${nights}ë°• ${days}ì¼`;
        }
        
        function parseEventDate(dateStr) {
            if (!dateStr) return null;
            
            // Handle both formats: 2025.09.10 and 2025-09-10
            let parts;
            if (dateStr.includes('.')) {
                parts = dateStr.split('.');
            } else if (dateStr.includes('-')) {
                parts = dateStr.split('-');
            } else {
                return null;
            }
            
            if (parts.length !== 3) return null;
            
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const day = parseInt(parts[2]);
            
            return new Date(year, month, day);
        }
        
        function viewEvaluationDetail(eventId) {
            const events = getEvents();
            const event = events.find(e => e.id === eventId);
            const infoDiv = document.getElementById('additionalInfo');
            
            if (!event) {
                infoDiv.innerHTML = '<p>í–‰ì‚¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            const reviews = getReviews().filter(r => r.eventId === eventId);
            
            let html = `<h3>${event.name} - í‰ê°€ ìƒì„¸</h3>`;
            html += `<p><button onclick="showEvaluations()" style="margin-bottom: 15px;">â† í‰ê°€ ê´€ë¦¬ë¡œ ëŒì•„ê°€ê¸°</button></p>`;
            
            if (!event.participants || event.participants.length === 0) {
                html += '<p>ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                html += `
                    <table border="1">
                        <thead>
                            <tr>
                                <th>ì°¸ê°€ìëª…</th>
                                <th>ìœ í˜•</th>
                                <th>í›„ê¸° ì œì¶œ</th>
                                <th>NPS ì ìˆ˜</th>
                                <th>ìƒíƒœ</th>
                                <th>ì œì¶œì¼</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                event.participants.forEach(participant => {
                    const review = reviews.find(r => r.participantName === participant.name);
                    const typeEmoji = participant.type === 'ëŒ€í‘œì˜ˆì•½ì' ? 'ğŸ‘‘' : 'ğŸ‘¥';
                    const hasSubmitted = participant.reviewSubmitted ? 'ì œì¶œ' : 'ë¯¸ì œì¶œ';
                    const npsScore = review ? review.npsScore : '-';
                    const status = getParticipantStatus(participant, event.period);
                    const submitDate = participant.reviewSubmitDate ? formatDate(participant.reviewSubmitDate) : '-';
                    
                    html += `
                        <tr>
                            <td>${participant.name}</td>
                            <td>${typeEmoji} ${participant.type}</td>
                            <td>${hasSubmitted}</td>
                            <td>${npsScore}</td>
                            <td>${status}</td>
                            <td>${submitDate}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            infoDiv.innerHTML = html;
        }
    </script>
</body>
</html>