<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í›„ê¸° ì‘ì„±í•˜ê¸°</title>
    <style>
        .selected-row {
            background-color: #e0e0e0;
        }
        tr:hover {
            cursor: pointer;
            background-color: #f0f0f0;
        }
        .review-section {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ccc;
        }
        .button-group {
            display: inline-block;
            margin-left: 10px;
        }
        .button-group button {
            margin: 0 5px;
        }
        .status-badge {
            display: inline-block;
            padding: 2px 6px;
            margin: 0 3px;
            border-radius: 3px;
            font-size: 12px;
        }
        .badge-sent {
            background-color: #4CAF50;
            color: white;
        }
        .badge-pending {
            background-color: #FFC107;
            color: black;
        }
    </style>
</head>
<body>
    <h1>í›„ê¸° ì‘ì„±í•˜ê¸°</h1>
    <nav>
        <a href="index.html">í™ˆìœ¼ë¡œ</a>
    </nav>
    
    <section>
        <h2>í–‰ì‚¬ ì„ íƒ</h2>
        <div>
            <label for="eventSelect">í–‰ì‚¬ ì„ íƒ:</label>
            <select id="eventSelect">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            </select>
        </div>
    </section>

    <section id="eventDetailSection" style="display: none;">
        <h2>í–‰ì‚¬ ì •ë³´</h2>
        <table border="1">
            <tr>
                <th>í–‰ì‚¬ëª…</th>
                <td id="eventName">-</td>
            </tr>
            <tr>
                <th>í–‰ì‚¬ ê¸°ê°„</th>
                <td id="eventPeriod">-</td>
            </tr>
            <tr>
                <th>ì¼ì •</th>
                <td id="eventSchedule">-</td>
            </tr>
            <tr>
                <th>í‰ê°€ ëŒ€ìƒ (ë‹´ë‹¹ ê°€ì´ë“œ)</th>
                <td id="eventGuide">-</td>
            </tr>
        </table>
    </section>

    <section id="participantSection" class="review-section" style="display: none;">
        <h2>ì°¸ê°€ì ëª©ë¡ ë° í›„ê¸° ì‘ì„±í•˜ê¸°</h2>
        <table border="1">
            <thead>
                <tr>
                    <th>ë²ˆí˜¸</th>
                    <th>ì´ë¦„</th>
                    <th>ìƒë…„ì›”ì¼</th>
                    <th>ìœ í˜•</th>
                    <th>ëŒ€í‘œì˜ˆì•½ì</th>
                    <th>í›„ê¸° ìƒíƒœ</th>
                    <th>ì‘ì—…</th>
                </tr>
            </thead>
            <tbody id="participantList"></tbody>
        </table>
    </section>

    <script src="shared.js"></script>
    <script>
        let selectedEventId = null;
        let currentEvent = null;

        document.addEventListener('DOMContentLoaded', function() {
            addCurrentDateDisplay();
            loadEventsToSelect();
            
            document.getElementById('eventSelect').addEventListener('change', function() {
                if (this.value) {
                    selectEvent(parseInt(this.value));
                } else {
                    selectedEventId = null;
                    currentEvent = null;
                    document.getElementById('eventDetailSection').style.display = 'none';
                    document.getElementById('participantSection').style.display = 'none';
                }
            });
        });

        function loadEventsToSelect() {
            const events = getEvents();
            const select = document.getElementById('eventSelect');
            
            select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            events.forEach(event => {
                // Show all events, even without participants
                const option = document.createElement('option');
                option.value = event.id;
                const participantCount = event.participants ? event.participants.length : 0;
                option.textContent = `${event.name} (${event.period}) - ì°¸ê°€ì ${participantCount}ëª…`;
                select.appendChild(option);
            });
        }

        function selectEvent(eventId) {
            selectedEventId = eventId;
            const events = getEvents();
            currentEvent = events.find(e => e.id === eventId);
            
            if (currentEvent) {
                displayEventDetails(currentEvent);
                loadParticipants(currentEvent);
                
                document.getElementById('eventDetailSection').style.display = 'block';
                document.getElementById('participantSection').style.display = 'block';
            }
        }

        function displayEventDetails(event) {
            document.getElementById('eventName').textContent = event.name;
            document.getElementById('eventPeriod').textContent = event.period;
            document.getElementById('eventSchedule').textContent = calculateSchedule(event.period);
            document.getElementById('eventGuide').textContent = event.guideName || '-';
        }

        function calculateSchedule(period) {
            if (!period || !period.includes('-')) return '-';
            
            // Handle both formats: "start - end" and "start-end"
            const parts = period.includes(' - ') ? period.split(' - ') : period.split('-');
            if (parts.length !== 2) return period;
            
            const startDate = parseDate(parts[0].trim());
            const endDate = parseDate(parts[1].trim());
            
            if (!startDate || !endDate) return period;
            
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const nights = diffDays - 1;
            const days = diffDays;
            
            return `${nights}ë°• ${days}ì¼`;
        }

        function parseDate(dateStr) {
            // Handle both formats: 2025.09.10 and 2025-09-10
            let parts;
            if (dateStr.includes('.')) {
                parts = dateStr.split('.');
            } else if (dateStr.includes('-')) {
                parts = dateStr.split('-');
            } else {
                return null;
            }
            
            if (parts.length !== 3) return null;
            
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const day = parseInt(parts[2]);
            
            return new Date(year, month, day);
        }

        function loadParticipants(event) {
            const tbody = document.getElementById('participantList');
            tbody.innerHTML = '';

            if (event.participants && event.participants.length > 0) {
                event.participants.forEach((participant, index) => {
                    const row = tbody.insertRow();
                    const typeEmoji = participant.type === 'ëŒ€í‘œì˜ˆì•½ì' ? 'ğŸ‘‘' : 'ğŸ‘¥';
                    const representativeName = participant.representative ? 
                        event.participants.find(p => p.id == participant.representative)?.name || '-' : '-';
                    
                    let reviewStatus = '';
                    if (participant.reviewStatus === 'ì‚­ì œë¨') {
                        reviewStatus = '<span class="status-badge" style="background-color: #dc3545; color: white;">ì‚­ì œë¨</span>';
                    } else if (participant.reviewSubmitted) {
                        if (participant.reviewStatus === 'ìˆ˜ì •ë¨') {
                            reviewStatus = '<span class="status-badge" style="background-color: #ffc107; color: black;">ìˆ˜ì •ë¨</span>';
                        } else {
                            reviewStatus = '<span class="status-badge badge-sent">ì œì¶œì™„ë£Œ</span>';
                        }
                    } else {
                        reviewStatus = '<span class="status-badge badge-pending">ë¯¸ì œì¶œ</span>';
                    }
                    
                    // Add notification badges
                    if (participant.firstNotificationSent) {
                        reviewStatus += ' <span class="status-badge badge-sent">1ì°¨ë°œì†¡</span>';
                    }
                    if (participant.secondNotificationSent) {
                        reviewStatus += ' <span class="status-badge badge-sent">2ì°¨ë°œì†¡</span>';
                    }
                    if (participant.linkShared) {
                        reviewStatus += ' <span class="status-badge badge-sent">ë§í¬ê³µìœ ë¨</span>';
                    }
                    
                    let actionButtons = '';
                    if (participant.type === 'ëŒ€í‘œì˜ˆì•½ì') {
                        // Check if this representative has companions (convert to string for comparison)
                        const hasCompanions = event.participants.some(p => 
                            p.type === 'ì¼í–‰' && String(p.representative) === String(participant.id)
                        );
                        
                        const firstBtnDisabled = participant.firstNotificationSent ? 'disabled' : '';
                        const secondBtnDisabled = participant.secondNotificationSent ? 'disabled' : '';
                        
                        // Get current date for button control
                        const currentDate = getCurrentDate();
                        const eventStartDate = getEventStartDate(currentEvent.period);
                        const isEventStarted = currentDate >= eventStartDate;
                        
                        let reviewButtons = '';
                        if (participant.reviewSubmitted) {
                            // Check if within review deadline and not deleted
                            const canModify = isWithinReviewDeadline(currentEvent.period) && 
                                            participant.reviewStatus !== 'ì‚­ì œë¨';
                            
                            if (canModify) {
                                reviewButtons = `
                                    <button onclick="editReview(${participant.id})" style="background-color: #ffc107; color: black; margin-right: 5px;">ìˆ˜ì •</button>
                                    <button onclick="deleteReview(${participant.id})" style="background-color: #dc3545; color: white; margin-right: 5px;">ì‚­ì œ</button>
                                `;
                            } else {
                                reviewButtons = '<span style="color: #666;">ìˆ˜ì •/ì‚­ì œ ë¶ˆê°€</span>';
                            }
                        } else {
                            // Check if deleted and cannot rewrite
                            if (participant.reviewStatus === 'ì‚­ì œë¨') {
                                reviewButtons = '<span style="color: #999;">ì¬ì‘ì„± ë¶ˆê°€</span>';
                            } else if (isEventStarted) {
                                reviewButtons = `<button onclick="openReviewForm(${participant.id})" style="margin-right: 5px;">í›„ê¸° í¼ ì˜¤í”ˆ</button>`;
                            } else {
                                reviewButtons = '<span style="color: #999;">í–‰ì‚¬ ì‹œì‘ í›„ ì´ìš© ê°€ëŠ¥</span>';
                            }
                        }
                        
                        // Add share link button if has companions and event has started
                        let shareLinkButton = '';
                        if (hasCompanions && isEventStarted) {
                            if (!participant.linkShared) {
                                shareLinkButton = `<button onclick="shareReviewLink(${participant.id})" style="background-color: #17a2b8; color: white; margin-right: 5px;">í›„ê¸° ë§í¬ ê³µìœ í•˜ê¸°</button>`;
                            }
                        }
                        
                        // Notification buttons based on date
                        const eventStartDateMinus1 = new Date(eventStartDate);
                        eventStartDateMinus1.setDate(eventStartDateMinus1.getDate() - 1);
                        const canSendFirstNotification = currentDate >= eventStartDateMinus1;
                        // 2ì°¨ ì•Œë¦¼í†¡: í–‰ì‚¬ ì‹œì‘ì¼ ì´í›„ + í›„ê¸°ë¥¼ ì œì¶œí•˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ
                        const canSendSecondNotification = isEventStarted && !participant.reviewSubmitted;
                        
                        let notificationButtons = '';
                        if (canSendFirstNotification) {
                            notificationButtons += `<button onclick="sendFirstNotification(${participant.id})" ${firstBtnDisabled} style="margin-right: 5px;">1ì°¨ ì•Œë¦¼í†¡</button>`;
                        }
                        if (canSendSecondNotification) {
                            notificationButtons += `<button onclick="sendSecondNotification(${participant.id})" ${secondBtnDisabled}>2ì°¨ ì•Œë¦¼í†¡</button>`;
                        }
                        
                        actionButtons = `
                            <div class="button-group">
                                ${reviewButtons}
                                ${shareLinkButton}
                                ${notificationButtons}
                            </div>
                        `;
                    } else {
                        // For companions, check if their representative has shared the link (convert to string for comparison)
                        const representative = event.participants.find(p => String(p.id) === String(participant.representative));
                        if (representative && representative.linkShared) {
                            // Get current date for button control
                            const currentDate = getCurrentDate();
                            const eventStartDate = getEventStartDate(currentEvent.period);
                            const isEventStarted = currentDate >= eventStartDate;
                            
                            if (participant.reviewSubmitted) {
                                // Check if within review deadline and not deleted
                                const canModify = isWithinReviewDeadline(currentEvent.period) && 
                                                participant.reviewStatus !== 'ì‚­ì œë¨';
                                
                                if (canModify) {
                                    actionButtons = `
                                        <button onclick="editReview(${participant.id})" style="background-color: #ffc107; color: black; margin-right: 5px;">ìˆ˜ì •</button>
                                        <button onclick="deleteReview(${participant.id})" style="background-color: #dc3545; color: white;">ì‚­ì œ</button>
                                    `;
                                } else {
                                    actionButtons = '<span style="color: #666;">ìˆ˜ì •/ì‚­ì œ ë¶ˆê°€</span>';
                                }
                            } else {
                                // Check if deleted and cannot rewrite
                                if (participant.reviewStatus === 'ì‚­ì œë¨') {
                                    actionButtons = '<span style="color: #999;">ì¬ì‘ì„± ë¶ˆê°€</span>';
                                } else if (isEventStarted) {
                                    actionButtons = `<button onclick="openReviewForm(${participant.id})">í›„ê¸° í¼ ì˜¤í”ˆ</button>`;
                                } else {
                                    actionButtons = '<span style="color: #999;">í–‰ì‚¬ ì‹œì‘ í›„ ì´ìš© ê°€ëŠ¥</span>';
                                }
                            }
                        } else {
                            actionButtons = '-';
                        }
                    }
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${participant.name}</td>
                        <td>${participant.birthdate}</td>
                        <td>${typeEmoji} ${participant.type}</td>
                        <td>${representativeName}</td>
                        <td>${reviewStatus}</td>
                        <td>${actionButtons}</td>
                    `;
                });
            } else {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="7" style="text-align: center;">ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.</td>';
            }
        }

        function openReviewForm(participantId) {
            const participant = currentEvent.participants.find(p => p.id === participantId);
            if (participant) {
                // Update review status
                participant.reviewFormOpened = true;
                updateEventData();
                
                // Open review form in new window
                const url = `review-form.html?eventId=${selectedEventId}&participantId=${participantId}`;
                window.open(url, '_blank');
            }
        }

        function sendFirstNotification(participantId) {
            const participant = currentEvent.participants.find(p => p.id === participantId);
            if (participant) {
                alert(`${participant.name}ë‹˜ì—ê²Œ 1ì°¨ ì•Œë¦¼í†¡ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.`);
                
                // Update notification status
                participant.firstNotificationSent = true;
                participant.firstNotificationDate = new Date().toISOString();
                updateEventData();
            }
        }

        function sendSecondNotification(participantId) {
            const participant = currentEvent.participants.find(p => p.id === participantId);
            if (participant) {
                alert(`${participant.name}ë‹˜ì—ê²Œ 2ì°¨ ì•Œë¦¼í†¡ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.`);
                
                // Update notification status
                participant.secondNotificationSent = true;
                participant.secondNotificationDate = new Date().toISOString();
                updateEventData();
            }
        }

        function updateEventData() {
            const events = getEvents();
            const eventIndex = events.findIndex(e => e.id === selectedEventId);
            if (eventIndex !== -1) {
                events[eventIndex] = currentEvent;
                localStorage.setItem(STORAGE_KEYS.EVENTS, JSON.stringify(events));
                loadParticipants(currentEvent);
            }
        }

        function editReview(participantId) {
            const participant = currentEvent.participants.find(p => p.id === participantId);
            if (!participant || !participant.reviewSubmitted) {
                alert('ì œì¶œëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // Check review deadline rule
            if (!isWithinReviewDeadline(currentEvent.period)) {
                alert('í–‰ì‚¬ ì¢…ë£Œ í›„ 14ì¼ì´ ê²½ê³¼í•˜ì—¬ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (participant.reviewStatus === 'ì‚­ì œë¨') {
                alert('ì‚­ì œëœ í›„ê¸°ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const currentScore = participant.npsScore || 0;
            const newScore = prompt(`ìƒˆë¡œìš´ NPS ì ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš” (0-10):\nì°¸ê°€ì: ${participant.name}\ní˜„ì¬ ì ìˆ˜: ${currentScore}`, currentScore);
            
            if (newScore === null) return; // ì·¨ì†Œ
            
            const score = parseInt(newScore);
            if (isNaN(score) || score < 0 || score > 10) {
                alert('0ë¶€í„° 10ê¹Œì§€ì˜ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (confirm(`${participant.name}ë‹˜ì˜ NPS ì ìˆ˜ë¥¼ ${currentScore}ì—ì„œ ${score}ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                // Update participant data
                participant.npsScore = score;
                participant.reviewSubmitDate = new Date().toISOString();
                participant.reviewStatus = 'ìˆ˜ì •ë¨';
                
                // Update reviews collection
                updateReviewScore(selectedEventId, participant.name, score, 'ìˆ˜ì •ë¨');
                
                updateEventData();
                alert('í›„ê¸°ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        function deleteReview(participantId) {
            const participant = currentEvent.participants.find(p => p.id === participantId);
            if (!participant || !participant.reviewSubmitted) {
                alert('ì œì¶œëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // Check review deadline rule
            if (!isWithinReviewDeadline(currentEvent.period)) {
                alert('í–‰ì‚¬ ì¢…ë£Œ í›„ 14ì¼ì´ ê²½ê³¼í•˜ì—¬ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (participant.reviewStatus === 'ì‚­ì œë¨') {
                alert('ì´ë¯¸ ì‚­ì œëœ í›„ê¸°ì…ë‹ˆë‹¤.');
                return;
            }

            if (confirm(`${participant.name}ë‹˜ì˜ í›„ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œ í›„ì—ëŠ” ì¬ì‘ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                // Mark as deleted but keep submitted status for tracking
                participant.reviewStatus = 'ì‚­ì œë¨';
                participant.deletedDate = new Date().toISOString();
                
                // Update review status in reviews collection
                updateReviewScore(selectedEventId, participant.name, participant.npsScore, 'ì‚­ì œë¨');
                
                updateEventData();
                alert('í›„ê¸°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ì¬ì‘ì„±ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.');
            }
        }

        function updateReviewScore(eventId, participantName, newScore, newStatus) {
            const reviews = getReviews();
            const review = reviews.find(r => r.eventId === eventId && r.participantName === participantName);
            
            if (review) {
                if (newScore !== undefined) review.npsScore = newScore;
                if (newStatus) review.status = newStatus;
                review.lastModifiedDate = new Date().toISOString();
                
                // Preserve writer information if it exists
                const events = getEvents();
                const event = events.find(e => e.id === eventId);
                if (event) {
                    const participant = event.participants.find(p => p.name === participantName);
                    if (participant && participant.reviewWriterType) {
                        review.writerType = participant.reviewWriterType;
                        if (participant.reviewCompanionName) {
                            review.companionName = participant.reviewCompanionName;
                        }
                    }
                }
                
                localStorage.setItem(STORAGE_KEYS.REVIEWS, JSON.stringify(reviews));
            }
        }

        function removeReviewByParticipant(eventId, participantName) {
            const reviews = getReviews();
            const filtered = reviews.filter(r => !(r.eventId === eventId && r.participantName === participantName));
            localStorage.setItem(STORAGE_KEYS.REVIEWS, JSON.stringify(filtered));
        }

        function getEventStartDate(eventPeriod) {
            if (!eventPeriod || !eventPeriod.includes('-')) return new Date();
            
            const parts = eventPeriod.split(' - ');
            let startDateStr = parts.length === 2 ? parts[0].trim() : eventPeriod.split('-')[0]?.trim();
            
            const startDate = parseEventDate(startDateStr);
            if (startDate) {
                startDate.setHours(0, 0, 0, 0);
                return startDate;
            }
            return new Date();
        }

        function parseEventDate(dateStr) {
            // Handle both formats: 2025.09.10 and 2025-09-10
            let parts;
            if (dateStr.includes('.')) {
                parts = dateStr.split('.');
            } else if (dateStr.includes('-')) {
                parts = dateStr.split('-');
            } else {
                return null;
            }
            
            if (parts.length !== 3) return null;
            
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const day = parseInt(parts[2]);
            
            return new Date(year, month, day);
        }

        function getCurrentDate() {
            const simulatedDate = localStorage.getItem('simulatedDate');
            if (simulatedDate) {
                const date = new Date(simulatedDate);
                date.setHours(0, 0, 0, 0);
                return date;
            }
            const date = new Date();
            date.setHours(0, 0, 0, 0);
            return date;
        }

        function isWithinReviewDeadline(eventPeriod) {
            if (!eventPeriod || !eventPeriod.includes('-')) return false;
            
            const parts = eventPeriod.split(' - ');
            let endDateStr = parts.length === 2 ? parts[1].trim() : eventPeriod.split('-')[1]?.trim();
            const endDate = parseEventDate(endDateStr);
            if (!endDate) return false;
            
            // Calculate review deadline: event end date + 14 days
            // For event 2025-09-10, deadline is 2025-09-24
            // Reviews can be modified/deleted until 2025-09-23 (before deadline)
            const reviewDeadlineDate = new Date(endDate);
            reviewDeadlineDate.setDate(reviewDeadlineDate.getDate() + 14);
            reviewDeadlineDate.setHours(0, 0, 0, 0);
            
            const currentDate = getCurrentDate();
            
            // Return true if current date is before deadline (can modify/delete)
            // Return false if current date is on or after deadline (cannot modify/delete)
            return currentDate < reviewDeadlineDate;
        }

        function shareReviewLink(representativeId) {
            const representative = currentEvent.participants.find(p => p.id === representativeId);
            if (!representative) {
                alert('ëŒ€í‘œì˜ˆì•½ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // Check if has companions (convert to string for comparison)
            const companions = currentEvent.participants.filter(p => 
                p.type === 'ì¼í–‰' && String(p.representative) === String(representativeId)
            );

            if (companions.length === 0) {
                alert('ì¼í–‰ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (confirm(`${companions.length}ëª…ì˜ ì¼í–‰ì—ê²Œ í›„ê¸° ë§í¬ë¥¼ ê³µìœ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì¼í–‰: ${companions.map(c => c.name).join(', ')}`)) {
                // Update representative's linkShared status
                representative.linkShared = true;
                representative.linkSharedDate = new Date().toISOString();
                
                updateEventData();
                alert('í›„ê¸° ë§í¬ê°€ ì¼í–‰ì—ê²Œ ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>
</html>